name: Mirror GitHub Pages build to Hostinger

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: 'hostinger-deploy'
  cancel-in-progress: true

jobs:
  build:
    name: Build static site
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        env:
          NODE_ENV: development
          npm_config_production: 'false'
        run: npm ci

      - name: Build frontend assets
        env:
          NODE_ENV: production
        run: npm run build

      - name: Upload static build artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist

  deploy:
    name: Deploy static site to Hostinger
    needs: build
    runs-on: ubuntu-latest
    if: ${{ github.ref == 'refs/heads/main' }}
    steps:
      - name: Download static build artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist

      - name: Upload static site to Hostinger
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOSTINGER_FTP_HOST }}
          username: ${{ secrets.HOSTINGER_FTP_USERNAME }}
          key: ${{ secrets.HOSTINGER_SSH_KEY }}
          port: 65002
          source: dist/*
          target: /home/u753768407/domains/savarix.com/public_html/
          overwrite: true
          timeout: 60s
          command_timeout: 15m
          strip_components: 1

      - name: Flatten deployment folder on Hostinger
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOSTINGER_FTP_HOST }}
          username: ${{ secrets.HOSTINGER_FTP_USERNAME }}
          key: ${{ secrets.HOSTINGER_SSH_KEY }}
          port: 65002
          script_stop: true
          script: |
            set -e

            TARGET="/home/u753768407/domains/savarix.com/public_html"
            STAGING="$TARGET/.deploy-sftp"

            move_contents() {
              SRC="$1"
              DEST="$2"

              for ITEM in "$SRC"/* "$SRC"/.[!.]* "$SRC"/..?*; do
                if [ -e "$ITEM" ]; then
                  mv "$ITEM" "$DEST"/
                fi
              done
            }

            if [ -d "$STAGING" ]; then
              move_contents "$STAGING" "$TARGET"
              rm -rf "$STAGING"
            fi

            if [ -d "$TARGET/dist" ]; then
              move_contents "$TARGET/dist" "$TARGET"
              rmdir "$TARGET/dist"
            fi

            LEGACY_FILES=(
              "$TARGET/index.php"
              "$TARGET/server.php"
              "$TARGET/web.config"
            )

            for FILE in "${LEGACY_FILES[@]}"; do
              if [ -f "$FILE" ]; then
                rm -f "$FILE"
              fi
            done

            if [ -f "$TARGET/.htaccess" ]; then
              grep -q 'RewriteRule ^ index.html' "$TARGET/.htaccess" || rm -f "$TARGET/.htaccess"
            fi

            ls -la "$TARGET"
