#!/usr/bin/env bash
set -euo pipefail

# Load environment variables from .env if it exists
if [ -f ".env" ]; then
  set -a
  source .env
  set +a
fi

# Ensure required environment variables are set. The OpenAI key is
# expected in the custom variable `ressapp_aktonz`. It is then exported
# as `OPENAI_API_KEY` for tools that rely on the default name.
: "${ressapp_aktonz:?ressapp_aktonz is not set}"
: "${OTHER_REQUIRED_KEY:?OTHER_REQUIRED_KEY is not set}"

# Map custom variable to the standard name used by Codex CLI
OPENAI_API_KEY="$ressapp_aktonz"

# Install Codex CLI if not already installed
if ! command -v codex-cli >/dev/null 2>&1; then
  if command -v npm >/dev/null 2>&1; then
    npm install -g @openai/codex-cli
  else
    echo "npm is required to install codex-cli but was not found." >&2
  fi
fi

# Export variables for this session
export OPENAI_API_KEY OTHER_REQUIRED_KEY

echo "Codex environment setup complete. Ensure .env contains your real keys."

